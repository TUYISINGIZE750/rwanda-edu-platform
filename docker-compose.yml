services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: rwanda_edu
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_SHARED_BUFFERS: 256MB
    ports:
      - "5435:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command: [
      "postgres",
      "-c", "max_connections=200",
      "-c", "shared_buffers=256MB",
      "-c", "effective_cache_size=1GB",
      "-c", "maintenance_work_mem=64MB",
      "-c", "checkpoint_completion_target=0.9",
      "-c", "wal_buffers=16MB",
      "-c", "default_statistics_target=100",
      "-c", "random_page_cost=1.1",
      "-c", "effective_io_concurrency=200",
      "-c", "work_mem=2MB",
      "-c", "min_wal_size=1GB",
      "-c", "max_wal_size=4GB"
    ]

  redis:
    image: redis:7-alpine
    ports:
      - "6381:6379"
    command: [
      "redis-server",
      "--maxmemory", "512mb",
      "--maxmemory-policy", "allkeys-lru",
      "--save", "60", "1000",
      "--appendonly", "yes"
    ]

  backend:
    build: ./backend
    ports:
      - "8080:8000"
    environment:
      DATABASE_URL: postgresql://user:pass@postgres:5432/rwanda_edu
      REDIS_URL: redis://redis:6379/0
      WORKERS: 4
      MAX_CONNECTIONS: 100
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

volumes:
  postgres_data:
