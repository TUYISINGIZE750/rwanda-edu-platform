name: Keep Backend Alive

on:
  schedule:
    - cron: '*/8 * * * *'  # Every 8 minutes (more frequent)
  workflow_dispatch:  # Manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Multi-endpoint Health Check
        run: |
          BACKEND_URL="https://rwanda-edu-platform.onrender.com"
          
          # Function to test endpoint
          test_endpoint() {
            local endpoint=$1
            local response=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint" --max-time 30 || echo "000")
            echo "$endpoint: HTTP $response"
            return $([ "$response" = "200" ] && echo 0 || echo 1)
          }
          
          # Test multiple endpoints to ensure server is fully awake
          echo "üîÑ Waking up Rwanda Education Platform..."
          
          # Primary health check
          if test_endpoint "$BACKEND_URL/health"; then
            echo "‚úÖ Primary health check passed"
          else
            echo "‚ö†Ô∏è Primary health check failed, trying secondary endpoints..."
          fi
          
          # Secondary endpoints to ensure full wake-up
          test_endpoint "$BACKEND_URL/api/v1/locations/provinces" || true
          test_endpoint "$BACKEND_URL/api/v1/auth/test" || true
          
          # Final verification
          if test_endpoint "$BACKEND_URL/health"; then
            echo "‚úÖ Server is fully awake and responsive"
          else
            echo "‚ùå Server wake-up failed - attempting force wake"
            # Force multiple requests
            for i in {1..5}; do
              curl -s "$BACKEND_URL/health" --max-time 10 || true
              sleep 2
            done
          fi
          
          echo "üèÅ Keep-alive cycle completed at $(date)"
